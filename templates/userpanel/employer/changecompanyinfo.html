{% extends 'userpanel/userpanel.html' %}
{% load filters %}
{% load staticfiles %}

{% block content-title %}
تغییر مشخصات شرکت
{% endblock %}

{% block content %}
<div id="companyinfoform">
	<h3>مشخات</h3>
	<div class="ui basic small form segment formpart basicinfo">
		<form method="post">
			{% csrf_token %}
			<div class="two fields">
				{{form.companyName|semfield}}
				{{form.companyType|semfield}}
			</div>
			<div class="two fields">
				{{form.registrationNumber|semfield}}
				{{form.establishDate|semfield}}
			</div>
			<div class="two fields">
				{{form.webSite|semfield}}
				{{form.contactEmail|semfield}}
			</div>

			<button class="ui small blue submit button" type="submit">ثبت</button>

			{% if state == 'success' %}
				<div class="change success">
					تغییرات با موفقیت ثبت شد
				</div>
			{% endif %}
		</form>
	</div>

	<h3>عکس‌های شرکت</h3>
	<div class="ui basic segment formpart imageupload">
			<div class="info">
				عکس‌های شرکت خود را بارگذاری کنید تا کارجویان در صفحه شرکت شماه مشاهده کنند
			</div>
			<div class="upload">
				<form class="uploadform">
					<input type="file" name="image">
					<button type="button" class="ui small blue button uploadimage">اضافه</button>
				</form>
			</div>
			<div class="rslides_wrapper">
				<ul class="rslides">
					{% for image in images %}
						<li><i data-image-id="{{image.id}}" class="large icon remove"></i><img src="{{image.image.url}}"></li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</div>

	<h3>صفحه شخصی</h3>
	<div class="ui basic segment formpart imageupload">
		<div class="zedit container">
			<!-- <div class="zedit item">
				<div class="zedit title">
					<h4>
						<i class="icon remove"></i>
						درباره من
					</h4>
				</div>
				<textarea class="zedit markup"></textarea>
				<div class="zedit buttons">
					<div class="zedit ui tiny green button">
						نمایش صفحه
					</div>
				</div>
			</div> -->
		</div>
	</div>	
</div>
{% endblock %}

{% block style %}
	{{ block.super }}
	<link rel="stylesheet" type="text/css" href="{% static 'css/rslides.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'markitup/skins/simple/style.css' %}" />
	<link rel="stylesheet" type="text/css" href="{% static 'markitup/sets/markdown/style.css' %}" />
	<style type="text/css">
		.zedit.container {
			padding-right: 10px;
		}

		.zedit .zedit.item {
			clear: both;
		}

		.zedit .title .icon.remove {
			cursor: pointer;
			margin-bottom: 10px;
		}

		.zedit .title .icon.remove:hover {
			color: rgb(200,100,0);
		}

		.zedit .title .icon.remove:active {
			color: rgb(200,50,0);
		}

		.zedit .markup {
			clear: both;
			margin-right: 30px;
		}

		.zedit .zedit.buttons {
			clear: both;
			margin-top: 10px;
		}

		.zedit .zedit.button {
			font-size: 12px;
			float: left;
			margin-right: 10px;
			font-family: yekan;
		}

		.zedit .zedit.status {
			font-size: 12px;
			margin-right: 50px;
			float: right;
		}

		.zedit .zedit.status.success {
			color: green;
		}

		.zedit .zedit.status.error {
			color: red;
		}


		.zedit .markItUpContainer {
			float: right;
			margin-bottom: 60px;
		}

		.zedit .zedit.add {
			clear: both;
			padding: 0px 30px;
		}

		.zedit .zedit.add .message{
			margin-bottom: 30px;
		}

		.zedit .zedit.add .input{
			float: right;
			width: 500px;
		}

		.zedit .zedit.add .button{
			float: right;
			margin-right: 20px;
			width: 100px;
		}

		.zedit.modal {
			direction: rtl;
		}

		#userpanel #companyinfoform .imageupload {
			/*border: 1px solid black;*/
			min-height: 300px;
		}

		#userpanel #companyinfoform .imageupload .info{
			/*border: 1px solid black;*/
			width: 370px;
			padding: 20px;
			position: absolute;
		}

		#userpanel #companyinfoform .imageupload .upload{
			/*border: 1px solid black;*/
			width: 400px;
			padding: 20px;
			position: absolute;
			bottom: 40px;
		}

		#userpanel #companyinfoform .rslides {
			position: relative;
			list-style: none;
			overflow: hidden;
			width: 300px;
			padding: 0;
			margin: 0;
			float:left;
		}

		#userpanel #companyinfoform .rslides li {
			-webkit-backface-visibility: hidden;
			position: absolute;
			display: none;
			width: 100%;
			left: 0;
			top: 0;
		}

		#userpanel #companyinfoform .rslides li:first-child {
			position: relative;
			display: block;
			float: left;
		}

		#userpanel #companyinfoform .rslides_tabs{
		 	background: rgba(100,100,0,.25);
			box-shadow: 0 0 1px rgba(255,255,255,.3), inset 0 0 5px rgba(0,0,0,1.0);
			-moz-box-shadow: 0 0 1px rgba(255,255,255,.3), inset 0 0 5px rgba(0,0,0,1.0);
			-webkit-box-shadow: 0 0 1px rgba(255,255,255,.3), inset 0 0 5px rgba(0,0,0,1.0);
			font-size: 18px;
			list-style: none;
			margin: 0 auto 10px;
			max-width: 540px;
			padding: 10px 0;
			text-align: center;
			width: 300px;

			clear: both;
			float: left;
		}
		#userpanel #companyinfoform .rslides_tabs li:first-child{
			margin-left: 0;
		}

		#userpanel #companyinfoform .rslides_tabs .rslides_here a {
			background: rgba(255,255,255,.1);
			color: #fff;
			font-weight: bold;
		}

		#userpanel #companyinfoform .rslides_tabs a {
			width: auto;
			line-height: 20px;
			padding: 9px 20px;
			height: auto;
			background: transparent;
			display: inline;
			text-decoration: none;
			color: black;
		}

		#userpanel #companyinfoform .rslides_tabs li{
		 	display: inline;
			float: none;
			margin-right: 1px;
		}

		#userpanel #companyinfoform .rslides img {
			display: block;
			height: auto;
			float: left;
			width: 100%;
			border: 0;
		}

		#userpanel #companyinfoform .rslides_wrapper {
			padding: 0px;
			margin: 0px;
			/*float: right;*/
		}

		#userpanel #companyinfoform .rslides .remove.icon {
			position: absolute;
			z-index: 100000;
			top: 10px;
			left: 6px;
			color: rgb(100,100,100);
			cursor: pointer;
		}

		#userpanel #companyinfoform .rslides .remove.icon:hover {
			color: rgb(200,100,0);
		}

		#userpanel #companyinfoform .rslides .remove.icon:active {
			color: rgb(200,50,0);
		}

		#userpanel #companyinfoform .imageupload .info {
			/*float: right;*/
		}
	</style>
{% endblock %}

{% block script %}
	{{ block.super }}
	<script type="text/javascript" src="{% static 'js/jquery.form.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/rslides.js' %}"></script>
	<script type="text/javascript" src="{% static 'markitup/jquery.markitup.js' %}"></script>
	<script type="text/javascript" src="{% static 'markitup/sets/markdown/set.js' %}"></script>
	<script type="text/javascript">
		$(function(){
			$('.zedit.markup').markItUp(mySettings);
			$('.markItUpButton a').html("");

			$.fn.zedit = function(){
				var zedit = $(this);

				function addItem(options){
					var itemDiv =  $("<div>").addClass("zedit item").addClass(options.page_id.toString());
					itemDiv.attr('data-item-id', options.page_id);
					
					var titleDiv = $("<div>").addClass("zedit title");
					titleDiv.append($("<h4>").append($("<i>").addClass("icon remove")).append(options.title));
					itemDiv.append(titleDiv);

					var markup = $("<textarea>").addClass("zedit markup");
					if(options.content){
						markup.val(options.content);
					}
					
					itemDiv.append(markup);
					zedit.find('.zedit.items').append(itemDiv);

					var buttonsDiv = $("<div>").addClass("zedit buttons");
					buttonsDiv.append($("<div>").addClass("zedit ui tiny green save button").html("دخیره تغییرات"));
					buttonsDiv.append($("<div>").addClass("zedit ui tiny blue preview button").html("نمایش"));
					buttonsDiv.append($("<div>").addClass("zedit status"));

					markup.markItUp(mySettings);
					// x = itemDiv;
					itemDiv.find('.markItUpButton a').html("");
					itemDiv.find('.markItUpFooter').append(buttonsDiv);
				}

				function removeItem(item_id){
					zedit.children('zedit item ' + item_id).remove();
				}

				if(typeof(arguments[0]) == 'string'){
					var com = arguments[0];
					if(com == 'add item'){
						var options = arguments[1];
						addItem(options);
					}else if(comm == 'remove item'){
						removeItem(arguments[1]);
					}

				}else if(typeof(arguments[0]) == 'object'){
					var options = arguments[0];
					zedit.options = options;
					
					if(zedit.options.url === undefined){
						console.log("zEdit error: no url given");
						return;
					}


					/* Initializing new zEdit */

					zedit.html('');
					zedit.append($('<div>').addClass('zedit items'));

					var addDiv = $('<div>').addClass('zedit add');
					addDiv.append($('<div>').addClass('message').html('برای اضافه کردن صفحه جدید نام آن را واردن کنید'));

					var input = $('<input>').attr('type', 'text').attr('placeholder', 'نام صفحه جدید');
					var button = $('<div>').addClass('ui small blue button').html('اضافه');
					addDiv.append($('<div>').addClass('ui  input').append(input)).append(button);

					zedit.append(addDiv);


					/* Initialize modal */

					var modal = $("<div>").addClass('ui modal zedit');
					var modalHeader = $("<div>").addClass("header");
					var modalContent = $("<div>").addClass("content");
					modal.append($("<i>").addClass("close icon"));
					// modal.append(modalHeader);
					modal.append(modalContent);
					$('body').append(modal);
					modal.modal();


					/* Add items */

					if(options.items){
						for(var i = 0; i < options.items.length; i++){
							addItem(options.items[i]);
						}
					}


					/* Load data */

					$.ajax({
						url: zedit.options.url,
						type: 'post',
						dataType: 'json',
						data: {action:'list'},
						success: function(data){
							if(data.result == 'success'){
								for(var i = 0; i < data.pages.length; i++){
									addItem(data.pages[i]);
								}							
							}else{
								console.log(data)
							}
						},
						error: function(data){
							throw data;
						}
					})

					/* Event handlers */

					function successStatus(item, message){
						item.find('.zedit.status').removeClass('error').addClass('success').html(message);
					}

					function errorStatus(item, message){
						item.find('.zedit.status').addClass('error').removeClass('success').html(message);
					}

					zedit.on('click', '.save.button', function(){
						var item = $(this).parents('.zedit.item');
						var item_id = item.attr('data-item-id');
						var content = item.find('textarea').val()
						$.ajax({
							url: zedit.options.url,
							type: 'post',
							dataType: 'json',
							data: {action:'save', page_id: item_id, content: content},
							success: function(data){
								if(data.result == 'success')
									successStatus(item,'تغییرات با موفقیت ثبت شد')
								else
									errorStatus(item,'در ذخیره تغییرات خطا رخ داده است');
								
							},
							error: function(data){
								errorStatus(item,'در ذخیره تغییرات خطا رخ داده است');
							}
						})
					})

					zedit.on('click', '.remove.icon', function(){
						var item = $(this).parents('.zedit.item');
						var item_id = item.attr('data-item-id');
						var title = item.find('.title').text();
						portal.showConfirmDialog('آیا مایل به حذف صفحه ' + title + 'هستید؟', function(){
							$.ajax({
								url: zedit.options.url,
								type: 'post',
								dataType: 'json',
								data: {action:'remove', page_id: item_id},
								success: function(data){
									if(data.result == 'success'){
										successStatus(item,'تغییرات با موفقیت ثبت شد')
										zedit.find('.zedit.item.' + item_id).remove();
									}else
										errorStatus(item,'در ذخیره تغییرات خطا رخ داده است');
									
								},
								error: function(data){
									errorStatus(item,'در ذخیره تغییرات خطا رخ داده است');
								}
							})
						});
					})

					zedit.on('click', '.preview.button', function(){
						var preview_url = '/zedit/preview/';
						if(options.preview_url !== undefined){
							preview_url = options.preview_url;
						}
						var item = $(this).parents('.zedit.item');
						var item_id = item.attr('data-item-id');
						$.ajax({
							url: preview_url,
							type: 'post',
							dataType: 'json',
							data: {content: item.find('.markup').val()},
							success: function(data){
								if(data.result == 'success'){
									successStatus(item, '');

									modalHeader.html(item.find('.zedit.title h4').text());
									modalContent.html(data.content);
									modal.modal('show')
								}else{
									errorStatus(item, 'در نمایش صفحه خطا رخ داده است');
								}
							},
							error: function(data){
								errorStatus(item, 'در نمایش صفحه خطا رخ داده است');
							}
						})
					})

					zedit.on('click', '.add .button', function(){
						var name = zedit.find('.add input').val();
						$.ajax({
							url: zedit.options.url,
							type: 'post',
							dataType: 'json',
							data: {action: 'add', title: name},
							success: function(data){
								if(data.result == 'success'){
									addItem(data.page);
									zedit.find('.add input').val('');	
								}else{
									throw data;
								}
							}
						})
					})	
				}


			}


			var a= $('.zedit.container');
			a.zedit({url:'/userpanel/companyinfo/zedit/'});
			// a.zedit('add item', {title:'درباره من', page_id:3});

			function initRSlides(){
				$('.rslides').responsiveSlides({
					auto: false,
					pager: true,
					speed: 1
				});
			}

			function imageSuccess(data){
				if(data.result == 'success'){
					var rslides = $("<ul>").addClass("rslides");
					for(var i = 0; i < data.images.length; i++){
						var icon  = $("<i>");
						icon.attr("data-image-id", data.images[i].id);
						icon.addClass("large icon remove");
						var img = $("<img>").attr("src", data.images[i].url);
						var li = $("<li>").append(icon).append(img);
						rslides.append(li);
					}

					$(".rslides_wrapper").html(rslides)
					initRSlides();
				} else if(data.result == 'fail'){
					console.log("Error uploading file: " + data.error)
				}
			}

			$('.uploadimage').click(function(){
				if($(".uploadform input[type='file']").fieldValue() != ''){
					$('.uploadform').ajaxSubmit({
						url: '/userpanel/companyinfo/uploadimage/',
						type: 'post',
						dataType: 'json',
						data: {action: 'upload'},
						success: function(data){
							imageSuccess(data);
							$('.uploadform input[type="file"]').clearFields();
						}
					})
				}
			})

			$(".rslides .remove.icon").click(function(){
				$.ajax({
					url: '/userpanel/companyinfo/removeimage/' + $(this).attr('data-image-id'),
					dataType: 'json',
					success: imageSuccess
				})
			})

			initRSlides();

			function changeFocus(){
				var active = this;
				$('.formpart').each(function(index){
					if(this == active){
						$(this).fadeTo(300, 1.0);
					}else{
						$(this).fadeTo(300, 0.5);
					}
				})

			}

			// $('.formpart').focusin(changeFocus);
			$('.formpart').hover(changeFocus);
		})
	</script>
{% endblock %}
